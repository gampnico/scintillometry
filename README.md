<!-- Copyright 2023 Nicolas Gampierakis.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    https://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License. -->

# Scintillometry Tools

[![Pytest and Flake8](https://github.com/gampnico/scintillometry-tools/actions/workflows/python-app.yml/badge.svg?branch=main)](https://github.com/gampnico/scintillometry-tools/actions/workflows/python-app.yml)

Analyse data & 2D flux footprints from Scintec's BLS scintillometers.

This repository is a complete rewrite of gampnico/ss19-feldkurs. If you have any existing forks or local clones, **please delete them**. The legacy code no longer works. No user features will be lost, but rewriting may take some time. Contributions are always welcome.

This package started life as part of a field course. If you spot any missing citations or licenses please contact me directly or open an issue.

# Processing Scintillometry Data in Complex Terrain

Scintillometry-Tools is configured for scintillometer experiments in Austria
using public or local data (ZAMG, InnFLUX), but is easily modified to work with
other data sources. Note that external data sources may have different licensing
constraints.

The package is currently in alpha and may change or break often. Support is only available for Python 3.8+ on debian-based Linux distros.

## Installation

Scintillometry-Tools supports installation as an editable with pip or conda.

### Install with Conda/Mamba

Activate your preferred conda environment and run:

```bash
git clone https://github.com/gampnico/scintillometry-tools.git
make install
```

That's it!

Install the package with optional dependencies:

```bash
make install-tests  # install with dependencies for tests
make install-docs   # install and build local documentation
make install-all    # install with tests and build local documentation
make install-dev    # install with dependencies for development
```

Installation uses conda if mamba is unavailable. Micromamba may also work, but is not currently supported.

### Install with Pip

If conda/mamba are not your package managers, then run:

```bash
git clone https://github.com/gampnico/scintillometry-tools.git
pip install -e .
```

Install the package with optional dependencies:

```bash
pip install -e .[tests]
pip install -e .[docs]
pip install -e .[tests,docs]    # no whitespace after comma
pip install -e .[dev]
```

# Features

## Scintillometry

Data processing:
- Parse scintillometry data from Scintec's BLS series of large aperture scintillometers (.mnd files).
- Recalibrate data if the scintillometer was incorrectly set up (e.g. wrong dip switch settings).
- Parse topographical data as path transect.
- Download and parse meteorological data.
- Parse InnFLUX and HATPRO data (local files only).

Metrics:
- Calculate effective path heights under various stability conditions.
- Derive C<sub>T</sub><sup>2</sup> values from C<sub>n</sub><sup>2</sup> if these were not collected.
- Estimate the time where stability conditions change. 
- Compute parameters such as Obukhov length, friction velocity, etc.
- Compute kinematic and sensible SHF. Supports free convection and iteration with MOST: several sets of coefficients are available for MOST functions, based on previous studies.

Visualisation:
- Produces path transects.
- Produces time series of scintillometry and meteorological data.
- Produces regression plots between calculated parameters and external data sources.

## Footprint Climatology (Roadmap)

Metrics:
- Process 2D flux footprints generated by Natascha Kljun's online model, available [here](http://footprint.kljun.net/).
- Adjust topography and stitch footprints together.

Visualisation:
- Overlay stitched footprints onto map.

## Workflow

### Example Workflow

This package supports SRun and Austrian-sourced data (ZAMG, InnFLUX) out-of-the-box. If your scintillometry readings were taken in Austria, use [DGM 5m data](https://www.data.gv.at/katalog/dataset/digitales-gelandemodell-des-landes-salzburg-5m) to generate topographical data for the scintillometer's path coordinates. Then generate the path transects necessary for calibrating the scintillometer.

**Scintillometer path coordinates must be accurate. Incorrectly generated topographical data leads to poor calibration and nonsense results!**

List all available arguments with:

```bash
python3 ./src/scintillometry/main.py -h
make commands   # if you prefer less typing
```

Navigate to the package root in the terminal. Calculate and plot surface
sensible heat fluxes using MOST in CET, with coefficients from Andreas (1988):

```bash
python3 ./src/scintillometry/main.py -i "./<path_to_input>/<bls_data>.mnd" \
-p "./<path_to_transect>/<transect_data>.csv" -t "CET"
```

If you are not using the scintillometer in Austria, you will need to find and parse topographical data yourself. Add or modify functions in ``wrangler/data_parsing.py`` to parse data from other scintillometers, organisations, or countries.

### Make Things Simple

The provided Makefile has many uses. View all the available commands:

```bash
make help       # display help for Makefile targets
make commands   # display help for scintillometry-tools
```

### Run from Terminal

From the package root, pass arguments like so:

```bash
src/scintillometry/main.py [-h] [-i <input_data>] [-p <path_data>] [-d] [...] [-v]
```

### Import as Package

Scintillometry-Tools and its submodules can be imported as a Python module:

```python
import scintillometry
from scintillometry.wrangler.data_parser import parse_scintillometer
```

MOST functions are stored in their respective class:

```python
from scintillometry.backend.iterations import IterationMost

workflow = IterationMost()
workflow.most_method(dataframe, eff_h, stability, coeff_id="an1988")
```

These classes inherit from the AtmosConstants class:

```python
from scintillometry.backend.constants import AtmosConstants

constants = AtmosConstants()
kelvin = constants.kelvin  # 273.15
```

# Acknowledgements

This project would not be possible without the invaluable contributions from Josef Zink, Dr. Manuela Lehner, and Dr. Helen Ward.
